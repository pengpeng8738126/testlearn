混合合约（全仓）

（这一版把平仓手续费放在了仓位保证金里面，会影响到冻结开仓成本和仓位保证金）
该文档包括两部分
一部分是文字版本，
一部分是图片形式（从静态和动态角度去解释概念）

为了方便解释，和在界面上的显示进行一一对应：

文中的账户权益对应于涂上的账户权益，可用对应于可用，已用对应于已用，未实现盈亏对应于总未实现盈亏，冻结对应于总冻结委托开仓成本。

混合合约，是多币种可以共用保证金，至于用什么币种作为保证金，用户可以自由选择，比如用户账户中只有ETH，此时想进行其他币种的交易，不想在进行换币，可以直接把ETH转入到混合合约账户作为可用资金进行交易其他币种，此时的ETH就类似与U本位的usdt可以交易任何合约，此时用户的账户权益，可用，未实现盈亏，已实现盈亏等均采用ETH计价 。

混合合约，目前采用每张0.001btc（这个分币种设置合约乘数）
合约类型	合约交易对	基础货币	计价货币	面值/张	最小价格变动单位	最小下单量/张	最大杠杆倍数	维持保证金率	手续费
混合合约	BTC/USDT	BTC	USDT	0.001BTC	0.5USDT	1	100	0.50%	Maker
0.04%
Taker
0.06%
	ETH/USDT	ETH	USDT	0.1ETH	0.01USDT	1	100	0.50%	
	LTC/USDT	LTC	USDT	0.1LTC	0.01USDT	1	50	1%	
	EOS/USDT	EOS	USDT	1EOS	0.001USDT	1	50	1%	
	XRP/USDT	XRP	USDT	10XRP	0.0001USDT	1	50	1%	
	BCH/USDT	BCH	USDT	0.01BCH	0.01USDT	1	50	1%	
	ETC/USDT	ETC	USDT	1ETC	0.001USDT	1	50	1%	
	LINK/USDT	LINK	USDT	1LINK	0.001USDT	1	20	2%	
 合约乘数及档位还需要再确认。

这里需要加上波动参数
 
这里和之前的合约最大的区别是委托开仓成本由固定变成浮动
带来的风险是换汇风险，平台的对冲负担相对加重
比如：
用户A用EOS作为保证金，用户B用ETH作为保证金，现在进行交易，
1、假定用户A获利正好是用户B亏钱
2、中间经过交易所，用户B把亏损先支付usdt对应的ETH给交易所，然后交易所给用户A相应的EOS，
对于交易所来说是收到了eth支付了eos（除非交易所在收到资金的那一刻进行实时的转换，但是现实是不可能实时转换的，首先用户同时平仓的可能性很小），相当于买入了EOS/ETH币对，而不是收到了usdt支付了usdt（这样没有加重平台负担）
风险在于交易所持有的EOS/ETH下跌

开仓均价，平仓均价，最新标记价格，最高买价最低卖价，资金费率这些可以直接调用之前公式。


固定参数：冻结上浮比例，手续费上浮比例，手续费率

1、可用余额（采用流水算法，是个状态值，对应全仓的balance，不同币种共用）
可用资金来源于用户的转入，资金费用的转入，以及累计已实现盈利的转入。其应该不需要计算，保存起来的，在balance字段中。全仓中包含了初始保证金。具体流水过程如下：
可用余额是通过用户的各种行为进行触发改变的：
（划转行为）转入，转出资金，直接读取
（结算行为）资金费用
（委托行为）冻结开仓成本
（开仓成功）开仓成功资金释放
（开仓委托撤单行为）开仓委托撤单资金释放
（持仓行为）仓位保证金
（平仓行为，包括强制平仓）平仓净收入
净转入 = 转入 - 转出
总资金费用 = 所有币对的资金费用之和
资金费用 = 标记价格计算的仓位价值*资金费率= 0，或者不显示
已实现盈亏 = 开仓方向*（平均平仓价格-平均开仓价格）*开仓方向*面值/平仓时保证金币的价格
平仓净收入 = 已实现盈亏 - 平仓手续费
平仓手续费 = 平均平仓价格*平仓张数*面值/平仓时刻保证金币价格*平仓手续费率 
开仓委托撤单资金释放 = 撤单张数*撤单价格*面值/保证金币价格/委托杠杆*（1+冻结上浮比例）+（撤单张数*撤单价格*面值/保证金币价格*手续费率）*（1+冻结手续费上浮比例）
开仓成功资金释放 = 仓位保证金（初始仓位保证金） + 多冻结资金释放
仓位保证金 = 开仓张数*开仓均价*面值/开仓时刻保证金币价格
多冻结资金释放 = 开仓张数*开仓均价*面值/开仓时刻保证金币价格*（1+冻结上浮比例）+开仓张数*开仓价格*面值/开仓时刻保证金币价格*手续费率*（1+冻结手续费上浮比例）- 仓位保证金 - 开仓价格*开仓张数*面值/开仓时刻的保证金币价格*手续费率
冻结开仓成本 = 委托张数*委托价格*面值/保证金币价格/委托的杠杆倍数*（1+冻结上浮比例）+（委托张数*委托价格*面值/保证金币价格/委托的杠杆倍数）*（1+冻结手续费上浮比例）


可用资金是通过获取用户是否发生以上行为的函数，行为是0，1变量，比如用户出现划转，划转=1，否则为0，由此得到可用余额的公式：

可用余额 = 上一刻的可用余额 + 划转动作*净转入 + 结算动作*总资金费用 + 平仓动作*平仓净收入 + 撤单动作*开仓委托撤单释放 +委托开仓成功动作*（开仓成功资金释放 - 冻结开仓成本）

如果由多个币种同时触发一个动作，应该是多币种的之和，这里认为只有资金费用会同时触发，理论上其他动作不同币种同时触发的可能性很小。

2、仓位价值（后续的仓位保证金，冻结开仓成本，追加保证金需要用到）
仓位价值 = 张数*面值*价格/保证金币价格
据此可以算出：
开仓委托价格的仓位价值：
开仓委托价格的仓位价值 = 开仓委托价格*委托张数*面值/当下的保证金币价格
持仓过程中的仓位价值：
持仓过程中的仓位价值 = 最新标记价格*持仓*面值/保证金币的最新标记价格
开仓时刻的仓位价值：
开仓时刻的仓位价值（以平均开仓价格计算的仓位价值） = 开仓均价*开仓张数*面值/开仓时刻保证金币价格
注意：后续涉及到仓位价值，都已经换算过保证金币

3、冻结开仓成本（单个币对），这个采用哪种保证金币价格需要讨论
冻结开仓成本是开仓时冻结的资金，从可用余额中转出，开仓成功后或者撤单后对应的资金会转回到可用余额中。该值是保存起来的，在freeze字段中。
冻结开仓成本 = （开仓委托价格的仓位价值/委托的杠杆倍数）*（1+冻结上浮比例）+（开仓委托价格的仓位价值*2*手续费率）*（1+冻结手续费上浮比例）
注意：这里面包含了平仓手续费

4、总冻结开仓成本
总冻结开仓成本 = 所有币对的冻结开仓陈本之和

5、总资产余额
总资产余额 = 可用余额 + 总冻结开仓成本

6、调整杠杆，追加保证金
追加初始保证金额 = 以平均开仓价格计算的仓位价值/新的杠杆倍数 - 以平均开仓价格计算的仓位价值/老杠杆倍数

7、仓位保证金（单个币对）
仓位保证金/初始保证金 = 多头初始保证金 + 空头初始保证金
初始保证金也被称为仓位保证金。其来源于冻结开仓成本的转入及用户调整杠杆导致的变化。经过计算后，全仓模式下放在了可用余额字段。
仓位保证金 = 开仓价格计算的仓位价值/杠杆倍数 +开仓价格计算的仓位价值*手续费率*（1+冻结手续费上浮比例）+ 追加初始保证金
注意：不同币种分别计算，最后都归于可用余额中
注意：这里面包含了平仓手续费


8、总仓位保证金
总仓位保证金 = 所有币对的仓位保证金之和

9、未实现盈亏（单个币对）
未实现盈亏 = 多头未实现盈亏 + 空头未实现盈亏
多头未实现盈亏 =（最新标价价格-开仓价格）*合约面值*持仓/保证金币最新标记价格
空头未实现盈亏 =（开仓价格-最新标价价格）*合约面值*持仓/保证金币最新标记价格
注意：后续涉及到未实现盈亏，都已经换算过保证金币


10、总未实现盈亏
总未实现盈亏 = 所有币对未实现盈亏之和

11、回报率（用于界面显示）
回报率 = 未实现盈亏/仓位保证金

12、账户权益
账户权益 = 总资产余额 + 总未实现盈亏
             = 可用余额 + 总冻结开仓成本 + 总未实现盈亏

13、总仓位价值（这里面包含了开仓委托时候的手续费）（这个是单个币种统计，不是所有币对的总和）
总仓位价值 = 仓位价值 + 冻结开仓成本*杠杆倍数

14、实际保证金率（这个是指单个币种）
实际保证金率 = （账户权益-其他币对的仓位保证金-其他币对的冻结开仓成本）/当前总仓位价值
                 = （总资产余额 + 总未实现盈亏 - 其他币对的仓位保证金 - 其他币对的冻结开仓成本）/当前总仓位价值
= 可用余额 + 总冻结开仓成本 + 总未实现盈亏 - 其他币对的仓位保证金 - 其他币对的冻结开仓成本
                 = （可用余额 - 其他币对的仓位保证金 + 其他币对的未实现盈亏 + 冻结开仓成本+未实现盈亏）/当前总仓位价值

这里：冻结开仓成本 = 总冻结开仓成本 - 其他币对的冻结开仓成本
      总未实现盈亏 = 其他币对的未实现盈亏 + 未实现盈亏

15、可用（可用于开仓的资金）
可用 = 可用余额 - 总仓位保证金（初始保证金） + 总未实现盈亏 


16、已用
已用 = 总仓位保证金（初始保证金） + 总冻结开仓成本

17、可转
可转 = MIN（可用，可用余额-体验金）
     	 

18、最大开仓量
最大开仓量的计算分为3步：
a、计算当前账户可用在当前杠杆下的最大开仓量M1
这个计算的思路是把当前的账户的可用都作为委托开仓保证金，在用户自己设置的杠杆下，以最高买价进行委托，最多能委托多少仓位，也即是委托冻结成本=全部可用资产
冻结开仓成本 = （开仓委托价格的仓位价值/委托的杠杆倍数）*（1+冻结上浮比例）+（开仓委托价格的仓位价值*手续费率）*（1+冻结手续费上浮比例）
冻结开仓成本=可用，可以得到用户可开仓张数，公式如下：
M1=可用*保证金币价格/（当前价格*面值*[（1+冻结上浮比例）/委托的杠杆倍数+手续费率*（1+冻结手续费上浮比例）]）
【注】在计算可开仓张数时，限价比例参数必须采用买价限价比例；其中，手续费按taker手续费计算
b、根据档位表查询当前持仓对应的档位的最大开仓量M2
计算该合约的总持仓，然后对应档位表查询最大的可开仓量M2
c、取M1和M2-当前持仓的最小值
最大开仓量 = min(M1,M2-当前持仓)



19、风险处理
计算爆仓价格
公式：
实际保证金率<维持保证金率

可用余额 - 其他币对的仓位保证金 + 其他币对的未实现盈亏 + 冻结开仓成本+未实现盈亏）/当前总仓位价值 < 维持保证金率 

可得到：
减仓价格 = （可用余额-其他币种的仓位保证金+其他币种的未实现盈亏+冻结开仓成本-多头开仓均价*多头持*面值/最新保证金币标记价格+空头开仓均*空头持仓*面值/最新保证金币标记价格-MM*冻结开仓成本*杠杆）/((MM*总持仓*面值-多头持仓*面值+空头持仓*面值）/保证金币最新标记价格）

注意：减仓价格在执行时会出现负数，0，算不出来的三种情形，处理方式按照全仓合约的处理方式。




20、结构图
静态图


动态图
整体过程，整体相当于面向对象的类的思维导图，用户的各种行为是对象




